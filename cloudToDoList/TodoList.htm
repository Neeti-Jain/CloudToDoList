

<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.8/firebase.js"></script>
    <script src="index.js"></script>
    <link rel="stylesheet" href="main2.css"></link>

    <script>

      var userEmail = localStorage.getItem("userEmail");

var userdatabase = firebase.database().ref('/users/' + userEmail + "/todolist/");
var listNameArray = [];

userdatabase.on('value',function(snapshot) {
    var jsonobj = JSON.parse(JSON.stringify(snapshot.val()))
    document.getElementById('userDataDiv').innerHTML="";
      listNameArray = []
    if(jsonobj!=null){
      initializeUI(jsonobj);
    }
});

/*
userdatabase.on('value').then(function(snapshot) {
var jsonobj = JSON.parse(JSON.stringify(snapshot.val()))

if(jsonobj!=null)
{
  initializeUI(jsonobj);
}
 //  var username = (snapshot.val() && snapshot.val().username) || 'Anonymous';
  //alert(JSON.stringify(snapshot.val()))
});
*/


function deleteListClick(listName)
{
    var r = confirm("Delete the list \""+listnameValue+"\" ?");
    if (r == true) {
      userdatabase.child(listName).remove();
    } 
}

function deleteTaskClick(listName, taskid)
{
    var r = confirm("Delete this task ?");
    if (r == true) {
      userdatabase.child(listName).child(taskid).remove();
    } 
}

function appendShareandAddTaskButton(parentdiv, listnameValue)
{
    var currentDate = new Date();
    var currentTime = currentDate.getTime();
    var taskButton = document.createElement("Button");
    taskButton.id="task"+currentTime;
    var textForButtonTask = document.createTextNode("Add New Task");
    taskButton.appendChild(textForButtonTask)
    
    //Add a button for Sharing a New List 
    var shareListButton = document.createElement("Button");
    shareListButton.innerHTML = "Share"

shareListButton.onclick = function() {

  


    var shareEmail = prompt("Please enter email id to Share");
    if (shareEmail != null) {
          shareEmail = shareEmail.trim().replace("@","").replace(".","").toLowerCase();
          firebase.database().ref('/users/' + userEmail + '/todolist/'+listnameValue).once('value').then(function(snapshot) {

            firebase.database().ref('/users/' + shareEmail + "/todolist/")
                                          .child("Shared "+listnameValue).set(snapshot.val());
          });

    }
};

    //Add a button for DELETING a  List 
    var deleteListButton = document.createElement("Button");
    deleteListButton.innerHTML = "Delete"

    deleteListButton.onclick = function(){deleteListClick(listnameValue);}

    taskButton.onclick = function() {
       if(listnameValue==''){
          alert('Enter List name');
       }
    else{
        addTaskClick(parentdiv, listnameValue, null, null, null)
         }
    };
    parentdiv.appendChild(taskButton);
    parentdiv.appendChild(shareListButton);
    parentdiv.appendChild(deleteListButton);
}

function initializeUI(jsonobj)
{
for (var listkey in jsonobj) {
    if (jsonobj.hasOwnProperty(listkey) && jsonobj[listkey]!=null) {
      
      listNameArray.push(listkey)

      var currentDate = new Date();
      var currentTime = currentDate.getTime();

      var listdiv = document.createElement('div');
      listdiv.id = "divi"+currentTime;
      listdiv.className  ="todolistdiv"
      listnameValue=listkey;
      var listNameLabel= document.createElement("p");
      listNameLabel.id = "p_list_name"+currentTime;
      listNameLabel.innerHTML = listnameValue;
      listdiv.appendChild(listNameLabel);
      listdiv.appendChild(document .createElement("br"));

      appendShareandAddTaskButton(listdiv, listkey)
      
      
      for (var taskkey in jsonobj[listkey]) {
        if(taskkey!= 'createdDate' && taskkey!='name')
          {
                addTaskDiv(
                  listnameValue,
                  taskkey,
                  listdiv, 
                  jsonobj[listkey][taskkey].taskname, 
                  jsonobj[listkey][taskkey].description);

            //alert("id="+taskkey)
            //alert("in inner ->" +  jsonobj[listkey][taskkey].taskname)
            //alert("in inner ->" +  jsonobj[listkey][taskkey].description)
          }
      }
       // console.log(listkey + " --------------------> " + jsonobj[listkey]);
    document.getElementById('userDataDiv').appendChild(listdiv);
    }
}
}

$(document).ready(function(){
    //$("#addlist").click(function(){
      //  $("#list").show();
    //});
    //$("#addtask").click(function(){
        //$("#task").show();
    

    //});
});
</script>
    <script type="text/javascript">
  var count=0;

function appendTask() {

  var listname=document.getElementById("listname").value;

  if(listname=='')
  {
    alert('Enter name')

  }
  else
  {

    document.getElementById("task_div").style.display = "block"
    document.getElementById("taskdes").value = '';
    document.getElementById("taskname").value='';
   
    // Create text with HTML
    // Create text with DOM
   // $("body").append(txt1, txt2, btnsubmit);     // Append new elements
}
}

function editTask(listnameValue, taskid, taskContainer, taskName, taskDescription)
{
  taskContainer.innerHTML = "";
  addTaskClick(taskContainer, listnameValue, taskid, taskName, taskDescription)
}


function addTaskDiv(listnameValue, taskid, parentdiv, taskName, taskDescription)
{
    var taskContainer=document.createElement('div');
    taskContainer.className  ="todolistdiv" 

    var nameTaskLabel = document.createTextNode('----Task Name-----');
    var nameTask = document.createTextNode(taskName);
    var descriptionLabel = document.createTextNode('----Description------');
    var descriptionValue = document.createTextNode(taskDescription);
    var buttonEdit = document.createElement("Button");
    //alert('parentdiv::'+parentdiv.id)
    buttonEdit.innerHTML='Edit'
     buttonEdit.onclick = function(){
      //editTask(taskid, parentdiv, taskName, taskDescription)
      editTask(listnameValue, taskid, taskContainer, taskName, taskDescription)
    };
    var buttonDelete = document.createElement("Button");
    buttonDelete.innerHTML='Delete'
    buttonDelete.onclick = function(){
      deleteTaskClick(listnameValue, taskid); 
    };


    taskContainer.appendChild(nameTaskLabel);
    taskContainer.appendChild(nameTask);
    taskContainer.appendChild(document .createElement("br"));

    taskContainer.appendChild(descriptionLabel);
    taskContainer.appendChild(descriptionValue);
    taskContainer.appendChild(document .createElement("br"));

    taskContainer.appendChild(buttonEdit);
    taskContainer.appendChild(document .createElement("br"));

    taskContainer.appendChild(buttonDelete);
    parentdiv.appendChild(taskContainer);
}
function createList(){
var currentDate = new Date();
var currentTime = currentDate.getTime();

var divElement = document.createElement('div');
divElement.id = "div"+currentTime;
divElement.className  ="todolistdiv"
var p='neeti';
//alert('divElement.id ::',divElement.id );
//alert(p)
var divCreatelistElement = document.createElement('div');

var iptNode = document.createElement("input");
iptNode.setAttribute("type", "text");
iptNode.id="list"+currentTime;



var listnamenode=document.createTextNode('Enter List Name');

//Add a button for ceating a New List 
var createListButton = document.createElement("Button");
createListButton.innerHTML = "Create List" 
createListButton.id="createlist"+currentTime;

var listnameValue ="new";
createListButton.onclick=function(){
    listnameValue=iptNode.value.trim();
    if(listNameArray.indexOf(listnameValue) > -1)
    {
       alert("List already exists.\nPlease choose another name") 
     }
  else
  {
    var listNameLabel= document.createElement("p");
    listNameLabel.id = "p_list_name"+currentTime;
    listNameLabel.innerHTML = listnameValue;
    
    // Server Call

    addlistDB(listnameValue);
    divElement.appendChild(listNameLabel);
    divCreatelistElement.style.display="none";
   
    divElement.appendChild(document .createElement("br"));

    appendShareandAddTaskButton(divElement, listnameValue)
  }
}


divCreatelistElement.appendChild(listnamenode);
divCreatelistElement.appendChild(iptNode);
divCreatelistElement.appendChild(createListButton );
//divCreatelistElement.appendChild(shareListButton);

divElement.appendChild(divCreatelistElement)


document.getElementById('userDataDiv').appendChild(divElement)
}

function addTaskClick(parentdiv, listnameValue, taskid, taskName, taskDescription){
    var divElementTask = document.createElement('p');
    var currentDate = new Date();
    var currentTime = currentDate.getTime();


    divElementTask.id = "paraID"+currentTime;

    var node=document.createTextNode('Enter Task Name');
    var iptNode = document.createElement("input");
    iptNode.setAttribute("type", "text");

    var iptNode1 = document.createElement("input");
    iptNode1.setAttribute("type", "text");
    var nodeDesc=document.createTextNode('  Enter Description');

    //if editing task
    if(taskid!=null)
    {
      iptNode.value = taskName;
      iptNode1.value = taskDescription;
    }

    var addTaskButton = document.createElement("Button");
    addTaskButton.id="addtask"+currentTime;
    addTaskButton.innerHTML = "Submit"
    addTaskButton.onclick = function() {
        var newtaskId = addUpdatetaskDB(taskid, listnameValue,iptNode1.value,iptNode.value)
        divElementTask.style.display="none";
        addTaskDiv(listnameValue,   newtaskId, parentdiv, iptNode.value, iptNode1.value);
    }

    divElementTask.appendChild(node);
    divElementTask.appendChild(iptNode);
    divElementTask.appendChild(nodeDesc);
    divElementTask.appendChild(iptNode1);
    divElementTask.appendChild(addTaskButton);

    //element.insertBefore(div,child);
    //document.getElementsById(data).insertBefore(divElementTask,child);
    //document.getElementById("myLI").parentElement.nodeName;
    parentdiv.appendChild(divElementTask);
}

function addToDB(){
    var database=firebase.database();
    currentDate = new Date();
    currentTime = currentDate.getTime();
    userid = 'user_'+currentTime;
    var userobject =   firebase.database().ref('users/' + "username");
}

function addlistDB(listname)
{
    var database=firebase.database();
    currentDate = new Date();
    currentTime = currentDate.getTime();
    userid = 'user_'+currentTime;
    var userobject =   firebase.database().ref('users/' + userEmail);
    userobject.child('todolist').child(listname).set({name:listname,createdDate: currentTime});
}

function addUpdatetaskDB(existingTaskid, listname,desc,tasknametext)
{
    var database=firebase.database();
    currentDate = new Date();
    currentTime = currentDate.getTime();
    userid = 'user_'+currentTime;
    var userobject =   firebase.database().ref('users/' + userEmail);

    var newtaskID;
    //Check if updating or new task
    if(existingTaskid == null)
    {
        //new task code
        var taskref = userobject.child('todolist').child(listname).push(
        {
          taskname : tasknametext,
          description : desc,
          createdDate : " "+currentDate
        });
         newtaskID = taskref.key;
    }
    else
    {
      //Updae code
      var taskref = userobject.child('todolist').child(listname).child(existingTaskid).set(
        {
          taskname : tasknametext,
          description : desc,
          createdDate : " "+currentDate
        });
      newtaskID = existingTaskid;
    }
    //document.getElementById("task_div").style.display = "none"
    return newtaskID;
}


        
          
</script>
</head>
  <body>
    <h2>My To Do List</h2>
    <p>
      <button id="addlist" onclick="createList()" class="button_green">Add New List</button>
    </p>
    <div id="userDataDiv"></div>
    <br/>
  </body>
</html>
